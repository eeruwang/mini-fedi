<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>mini-fediview</title>
  <style>
    /* ====== Theme tokens ====== */
    :root {
      --bg: #ffffff;
      --fg: #0b0e12;
      --muted: rgba(0,0,0,0.55);
      --card: #f7f9fc;
      --border: rgba(0,0,0,0.08);
      --btn-bg: rgba(0,0,0,0.04);
      --btn-bg-hover: rgba(0,0,0,0.08);
      --link: #1b6fff;
      --shadow: 0 1px 2px rgba(0,0,0,0.04), 0 6px 24px rgba(0,0,0,0.06);
      --radius: 14px;
      --radius-sm: 10px;
      --radius-lg: 18px;
    }
    :root[data-theme="dark"] {
      --bg: #0b0e12;
      --fg: #e6eef8;
      --muted: rgba(230,238,248,0.7);
      --card: rgba(255,255,255,0.06);
      --border: rgba(255,255,255,0.08);
      --btn-bg: rgba(255,255,255,0.06);
      --btn-bg-hover: rgba(255,255,255,0.12);
      --link: #98c1ff;
      --shadow: 0 1px 2px rgba(0,0,0,0.25), 0 6px 24px rgba(0,0,0,0.3);
    }
    @media (prefers-color-scheme: dark) {
      :root:not([data-theme]) {
        --bg: #0b0e12;
        --fg: #e6eef8;
        --muted: rgba(230,238,248,0.7);
        --card: rgba(255,255,255,0.06);
        --border: rgba(255,255,255,0.08);
        --btn-bg: rgba(255,255,255,0.06);
        --btn-bg-hover: rgba(255,255,255,0.12);
        --link: #98c1ff;
        --shadow: 0 1px 2px rgba(0,0,0,0.25), 0 6px 24px rgba(0,0,0,0.3);
      }
    }

    /* ====== Layout/Base ====== */
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--fg); }
    header {
      position: sticky; top: 0;
      background: color-mix(in oklab, var(--bg) 72%, transparent);
      -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border); z-index: 10;
    }
    .wrap { max-width: 840px; margin: 0 auto; padding: 12px 16px; }
    .row { display: flex; gap: 8px; align-items: center; }

    /* ====== Controls ====== */
    .btn {
      padding: 8px 12px; border-radius: var(--radius-sm);
      background: var(--btn-bg); border: 1px solid var(--border); color: var(--fg); cursor: pointer;
      transition: background .15s ease, transform .06s ease, box-shadow .15s ease;
    }
    .btn:hover { background: var(--btn-bg-hover); }
    .btn:active { transform: translateY(1px); }
    .pill {
      padding: 6px 10px; border: 1px solid var(--border);
      border-radius: 999px; background: var(--card);
    }

    /* ====== Post card ====== */
    .post {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      border-radius: 0; /* ë¦¬ìŠ¤íŠ¸ ê¸°ë³¸ */
    }
    /* ë” ì¹´ë“œìŠ¤ëŸ½ê²Œ ë³´ì´ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ë‘ ì¤„ì˜ ì£¼ì„ì„ í’€ì–´ ì‚¬ìš© */
    .post:first-child { border-top-left-radius: var(--radius); border-top-right-radius: var(--radius); }
    .post:last-child  { border-bottom-left-radius: var(--radius); border-bottom-right-radius: var(--radius); border-bottom: 1px solid var(--border); }

    /* ê°œë³„ ì¹´ë“œë¥¼ ë– ë³´ì´ê²Œ (ë¦¬ìŠ¤íŠ¸ ì „ì²´ê°€ ì•„ë‹ˆë¼ ì¹´ë“œí˜•ìœ¼ë¡œ ì“°ë ¤ë©´ .postì— box-shadow ì ìš©) */
    .post.cardish {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin: 10px 0;
      border-bottom: none;
      transition: transform .06s ease, box-shadow .2s ease;
    }
    .post.cardish:hover { transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,.05), 0 14px 34px rgba(0,0,0,.08); }

    .post-head { display:flex; gap:10px; align-items:center; margin-bottom:6px; }
    .avatar { width:42px; height:42px; border-radius:999px; object-fit:cover; background:#222; flex:0 0 42px; }
    .name { font-weight: 700; font-size: 15px; line-height: 1.2; }
    .name img { height: 1em; width: auto; vertical-align: -0.15em; }
    .meta { opacity:.7; font-size: 12px; }

    /* ====== Content typography ====== */
    .content { line-height: 1.58; font-size: 15px; word-wrap: break-word; overflow-wrap: anywhere; }
    .content p { margin: 0.25em 0 0.6em; }
    .content p:first-child { margin-top: 0; }
    .content a { color: var(--link); text-decoration: underline; text-underline-offset: 2px; }
    .content a:hover { text-decoration-thickness: 2px; }
    .content blockquote {
      margin: .6em 0; padding: .6em .8em;
      border-left: 3px solid var(--border); background: color-mix(in oklab, var(--card) 80%, transparent);
      border-radius: var(--radius-sm);
    }
    .content code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: .92em; padding: .15em .4em; border-radius: 6px;
      background: color-mix(in oklab, var(--card) 86%, transparent);
      border: 1px solid var(--border);
    }
    .content pre {
      overflow-x:auto; padding: .8em; border-radius: var(--radius);
      background: color-mix(in oklab, var(--card) 90%, transparent);
      border: 1px solid var(--border);
    }
    .content img.emoji, .content img[alt^=":"][alt$=":"] {
      height: 1.2em; width: auto; vertical-align: -0.2em;
    }

    /* ====== Media grid ====== */
    .media { margin-top: 10px; }
    .media > * { display: block; width: 100%; border-radius: var(--radius); }
    /* ê¸°ë³¸ 1ì¥ */
    .media:has(img:nth-child(1):last-child),
    .media:has(video:nth-child(1):last-child) {
      display: block;
    }
    /* 2~4ì¥ ê·¸ë¦¬ë“œ */
    .media:has(img:nth-child(2)),
    .media:has(video:nth-child(2)) {
      display: grid; gap: 8px;
      grid-template-columns: repeat(2, 1fr);
    }
    .media img, .media video {
      width: 100%; height: auto; border-radius: var(--radius);
      background: #000; object-fit: cover;
    }
    .media img:is(:only-child), .media video:is(:only-child) { aspect-ratio: 16/9; object-fit: cover; }
    @media (max-width: 520px) {
      .media:has(img:nth-child(3)), .media:has(video:nth-child(3)) { grid-template-columns: 1fr; }
    }

    /* ====== Reactions ====== */
    .reactions {
      display: flex; flex-wrap: wrap; gap: 6px;
      margin-top: 12px; padding-top: 8px; border-top: 1px solid var(--border);
    }
    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      border-radius: 999px; padding: 6px 10px;
      font-size: 12px; line-height: 1;
      transition: background .15s ease, transform .06s ease, border-color .15s ease;
    }
    .badge:hover { background: var(--btn-bg-hover); }
    .badge:active { transform: translateY(1px); }
    .badge img { height: 1.1em; width: auto; vertical-align: -0.2em; border-radius: 3px; }
    .like-btn[aria-pressed="true"] { background: color-mix(in oklab, var(--link) 12%, var(--card)); border-color: color-mix(in oklab, var(--link) 25%, var(--border)); }

    /* ====== Reblog/Boost ====== */
    .post.reblog { padding: 8px 16px 14px; background: transparent; border-bottom: 1px solid var(--border); }
    .reblog-banner {
      display:flex; align-items:center; gap:8px;
      font-size:12px; opacity:.75; margin: 4px 0 8px;
    }
    .reblog-banner .icon { transform: rotate(0turn); }
    .reblog-inner {
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: var(--radius);
      padding: 12px;
      position: relative;
      box-shadow: var(--shadow);
    }
    .reblog-inner::before {
      content: ""; position: absolute; left: 0; top: 10px; bottom: 10px;
      width: 3px; border-radius: 3px; background: var(--border);
    }
    .reblog-inner .post-head { margin-bottom: 4px; }
    .reblog-inner .name { font-weight: 700; }
    .reblog-inner .content { margin-top: 6px; }

    /* ====== Header account chip ====== */
    .acct { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; }
    .acct .avatar-mini, #acct-avatar {
      width: 18px; height: 18px; border-radius: 999px; object-fit: cover; background: #222;
    }

    /* ====== Thread (replies) ====== */
    .thread {
      margin-top: 8px; padding-left: 14px;
      border-left: 2px solid var(--border);
      animation: fadeIn .18s ease;
    }
    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }
    .thread .post {
      background: none;
      border-bottom: 1px dashed var(--border);
      padding-left: 0;
    }
    .thread .post:last-child { border-bottom: 0; }

    /* ====== Links/Focus ====== */
    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }
    :focus-visible { outline: 2px solid color-mix(in oklab, var(--link) 60%, transparent); outline-offset: 2px; }

    /* ====== Utilities ====== */
    .muted { color: var(--muted); }

    /* ë¦¬ë¸”ë¡œê·¸ ë°°ë„ˆ/ìœ ì €ì¹©ì˜ ë¯¸ë‹ˆ ì•„ë°”íƒ€ ê³ ì • í¬ê¸° */
    .user-chip .avatar-mini,
    .reblog-banner .avatar-mini {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      object-fit: cover;
      background: #222;
      flex: 0 0 16px;
      aspect-ratio: 1 / 1;
    }
    /* ìƒˆ ê¸€ ìŠ¬ë¼ì´ë“œ ì¸ ì• ë‹ˆë©”ì´ì…˜ */
    .post.slide-enter {
      transform: translateY(-14px);
      opacity: 0;
    }
    .post.slide-enter-active {
      transform: translateY(0);
      opacity: 1;
      transition: transform .28s ease, opacity .28s ease;
    }

    /* ì•„ë˜ spacerëŠ” ê¸°ì¡´ í¬ìŠ¤íŠ¸ë“¤ì´ "ë°€ë ¤ ë‚´ë ¤ê°€ëŠ”" ì—°ì¶œìš© */
    .new-spacer {
      height: 0px;
      transition: height .28s ease;
    }

    .likers {
      overflow: hidden;
      margin-top: 8px;
      border-top: 1px dashed var(--border);
      padding-top: 8px;
      animation: fadeIn .18s ease;
    }

    .likers-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 8px;
    }

    .liker-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--card) 96%, transparent);
      border-radius: var(--radius-sm);
      padding: 6px 8px;
    }

    .liker-chip img {
      width: 28px; height: 28px; border-radius: 999px; object-fit: cover; background: #222;
    }

    .liker-chip .txt { line-height: 1.2; }
    .liker-chip .txt .meta { display:block; font-size: 12px; opacity:.7; }



  </style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="row" style="gap:6px;">
      <button id="tab-home" class="btn">Home</button>
      <button id="tab-fav" class="btn">Favourites</button>
    </div>
    <div style="flex:1"></div>
    <div class="row">
      <!-- header ì˜¤ë¥¸ìª½ -->
      <button id="acct-btn" class="pill acct" title="ë‚´ ê¸€ ë³´ê¸°">
        <img id="acct-avatar" class="avatar-mini" alt="" />
        <span id="acct-name">â€¦</span>
      </button>
      <button id="theme-toggle" class="btn" title="Toggle theme">ğŸŒ™</button>
      <button id="logout" class="btn">Logout</button>
    </div>
  </div>
</header>

<main class="wrap" id="feed"></main>
<div id="sentinel" style="height:60px;"></div>

<script>
/* =========================
   Helpers (cookies / fetch)
   ========================= */
function getCookie(name) {
  const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([$?*|{}\]\\^])/g, '\\$1') + '=([^;]*)'));
  return m ? decodeURIComponent(m[1]) : '';
}
async function jfetch(url, opts = {}) {
  const r = await fetch(url, { credentials: 'include', ...opts });
  if (!r.ok) {
    const text = await r.text().catch(() => '');
    const err = new Error(`${r.status} ${r.statusText}`);
    // @ts-ignore
    err.status = r.status; err.body = text;
    throw err;
  }
  const ct = r.headers.get('content-type') || '';
  return ct.includes('application/json') ? r.json() : r.text();
}
// â­ ëˆ„ë¥´ë©´ "ì¢‹ì•„ìš”í•œ ì‚¬ëŒ" ëª©ë¡ì„ ì•„ë˜ë¡œ í¼ì¹˜ê¸° (ë‚´ ê¸€ ì „ìš©)
const likersCache = new Map(); // id -> HTML

document.addEventListener('click', async (ev) => {
  const btn = ev.target.closest('.likers-toggle');
  if (!btn) return;

  const id = btn.dataset.id;
  if (!id) return;

  // ì´ ì¹´ë“œì˜ likers ì»¨í…Œì´ë„ˆ ì°¾ê¸°
  const article = btn.closest('article');
  let box = article?.querySelector(`.likers[data-for="${CSS.escape(id)}"]`);
  if (!box) return;

  // í† ê¸€: ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
  if (!box.hasAttribute('hidden')) {
    box.setAttribute('hidden', '');
    btn.title = 'Show who liked';
    return;
  }

  // ìºì‹œê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ í‘œì‹œ
  if (likersCache.has(id)) {
    box.innerHTML = likersCache.get(id);
    box.removeAttribute('hidden');
    btn.title = 'Hide likers';
    return;
  }

  // ë¡œë”© í‘œì‹œ
  box.innerHTML = `<div class="meta">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>`;
  box.removeAttribute('hidden');
  btn.title = 'Hide likers';

  try {
    const users = await jfetch(`/api/status/favourited_by?id=${encodeURIComponent(id)}`);
    const list = Array.isArray(users) ? users : [];

    if (!list.length) {
      box.innerHTML = `<div class="meta">ì•„ì§ ì¢‹ì•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      likersCache.set(id, box.innerHTML);
      return;
    }

    // ì‚¬ìš©ì ì¹© ë Œë”
    const chips = list.map(u => {
      const name = (u.display_name || u.username || '').toString();
      const handle = u.acct ? `@${u.acct}` : '';
      const ava = u.avatar_static || u.avatar || '';
      return `
        <div class="liker-chip">
          <img src="${ava}" alt="" loading="lazy" />
          <div class="txt">
            <strong>${escapeHTML(name)}</strong>
            <span class="meta">${escapeHTML(handle)}</span>
          </div>
        </div>`;
    }).join('');

    box.innerHTML = `<div class="likers-list">${chips}</div>`;
    likersCache.set(id, box.innerHTML);

  } catch (e) {
    console.error('likers fetch error', e);
    box.innerHTML = `<div class="meta">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
  }
});

/* =========================
   Theme toggle
   ========================= */
const THEME_KEY = 'theme';
function getPreferredTheme() {
  const saved = localStorage.getItem(THEME_KEY);
  if (saved === 'light' || saved === 'dark') return saved;
  return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
}
function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  const btn = document.getElementById('theme-toggle');
  if (btn) btn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
}
function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme') || getPreferredTheme();
  const next = current === 'dark' ? 'light' : 'dark';
  localStorage.setItem(THEME_KEY, next);
  applyTheme(next);
}
applyTheme(getPreferredTheme());
try {
  const mql = window.matchMedia('(prefers-color-scheme: dark)');
  mql.addEventListener?.('change', e => {
    const saved = localStorage.getItem(THEME_KEY);
    if (saved !== 'light' && saved !== 'dark') applyTheme(e.matches ? 'dark' : 'light');
  });
} catch {}

/* =========================
   Emoji map (Misskey & Masto)
   ========================= */
const emojiMapCache = new Map();      // host -> [{name,url}]
const emojiMapPromise = new Map();    // host -> Promise

async function getMisskeyEmojis(host) {
  if (!host) return [];
  if (emojiMapCache.has(host)) return emojiMapCache.get(host);
  if (emojiMapPromise.has(host)) return emojiMapPromise.get(host);

  const p = jfetch(`/api/mk/meta?host=${encodeURIComponent(host)}`)
    .then(data => {
      const list = Array.isArray(data?.emojis) ? data.emojis : [];
      emojiMapCache.set(host, list);
      emojiMapPromise.delete(host);
      return list;
    })
    .catch(() => {
      emojiMapPromise.delete(host);
      return [];
    });
  emojiMapPromise.set(host, p);
  return p;
}

function buildMastoEmojiMap(status) {
  const all = [];
  if (Array.isArray(status?.emojis)) all.push(...status.emojis);
  if (Array.isArray(status?.account?.emojis)) all.push(...status.account.emojis);
  if (Array.isArray(status?.poll?.emojis)) all.push(...status.poll.emojis);
  const out = [];
  for (const e of all) {
    if (e && typeof e.shortcode === 'string' && typeof e.url === 'string') {
      out.push({ name: e.shortcode, url: e.url });
    }
  }
  const seen = new Set();
  return out.filter(e => (seen.has(e.name) ? false : (seen.add(e.name), true)));
}

/* =========================
   Emoji rendering
   ========================= */
function renderEmojisToHTML(textOrHTML, emojiList) {
  if (!textOrHTML || !emojiList?.length) return textOrHTML || '';
  let html = String(textOrHTML);
  for (const e of emojiList) {
    if (!e?.name || !e?.url) continue;
    const re = new RegExp(`:${e.name}:`, 'g');
    html = html.replace(
      re,
      `<img src="${e.url}" alt=":${e.name}:" style="height:1.2em;width:auto;vertical-align:-0.2em;aspect-ratio:auto;display:inline-block;">`
    );
  }
  return html;
}
function escapeHTML(s='') {
  return s.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[ch]));
}

/* =========================
   Auto refresh (polling)
   ========================= */
let lastTopId = null;
let refreshTimer = null;

function getIdFromPost(item) {
  // Masto/ë¶€ìŠ¤íŠ¸ ëª¨ë‘ ëŒ€ì‘
  return item?.reblog?.id ?? item?.id ?? null;
}

function startPolling() {
  if (refreshTimer) return;
  refreshTimer = setInterval(checkForUpdates, 30000); // 30s
}

function stopPolling() {
  if (!refreshTimer) return;
  clearInterval(refreshTimer);
  refreshTimer = null;
}

async function checkForUpdates() {
  try {
    if (!source || mode !== 'home' || !lastTopId) return;

    // since_id=lastTopId ë¡œ "ê·¸ ì´í›„ ìƒˆ ê¸€ë§Œ" ìš”ì²­
    const base = source === 'masto' ? '/api/home' : '/api/mk/home';
    const url = new URL(base, location.origin);
    url.searchParams.set('merge', '0');          // ê°€ë²¼ìš´ ì‘ë‹µ
    url.searchParams.set('limit', '20');         // í•œ ë²ˆì— ìµœëŒ€ 20ê°œê¹Œì§€
    if (source === 'masto') url.searchParams.set('since_id', lastTopId); // â¬…ï¸ í•µì‹¬
    else url.searchParams.set('sinceId', lastTopId);   // â† MisskeyëŠ” ì¹´ë©œ

    const data = await jfetch(url.toString());
    const items = Array.isArray(data?.items) ? data.items : Array.isArray(data) ? data : [];
    if (!items.length) return;

    // ìƒˆ ê¸€ì€ ì„œë²„ê°€ "ìµœì‹ â†’ì˜¤ë˜ëœ" ìˆœìœ¼ë¡œ ì¤„ ê°€ëŠ¥ì„±ì´ í¬ë‹ˆ,
    // DOMì— ë„£ì„ ë• ë°˜ëŒ€ë¡œ(ì˜¤ë˜ëœâ†’ìµœì‹ ) ìˆœì„œë¡œ prepend í•´ì•¼ ìì—°ìŠ¤ëŸ¬ì›€
    const toPrepend = [...items].reverse();

    // í˜„ì¬ ìŠ¤í¬ë¡¤ì´ ë§ì´ ë‚´ë ¤ê°€ ìˆìœ¼ë©´ ê°‘ì‘ìŠ¤ëŸ° ì í”„ ë°©ì§€ (ì„ íƒ)
    const nearTop = window.scrollY < 80;

    for (const post of toPrepend) {
      const html = await renderPostHTML(post, { source });
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      const node = wrapper.firstElementChild;

      // ìƒë‹¨ì— ê½‚ê¸°
      if (feedEl.firstChild) feedEl.insertBefore(node, feedEl.firstChild);
      else feedEl.appendChild(node);
    }

    // ìƒˆ ìµœìƒë‹¨ id ë¡œ ê°±ì‹ 
    const newest = toPrepend[toPrepend.length - 1];
    const newTopId = newest?.reblog?.id ?? newest?.id ?? null;
    if (newTopId) lastTopId = newTopId;

    // ì‚´ì§ ê°•ì¡° ì• ë‹ˆë©”ì´ì…˜ (ì„ íƒ)
    try {
      for (let i = 0; i < toPrepend.length; i++) {
        const el = feedEl.children[i];
        el.style.transition = 'background-color .8s ease';
        el.style.backgroundColor = 'color-mix(in oklab, var(--link) 12%, var(--card))';
        setTimeout(() => { el.style.backgroundColor = ''; }, 50);
        setTimeout(() => { el.style.transition = ''; }, 900);
      }
    } catch {}

    // ìŠ¤í¬ë¡¤ ìƒë‹¨ ìœ ì§€ (ì˜µì…˜)
    if (nearTop) {
      // ì•„ë¬´ ê²ƒë„ ì•ˆ í•´ë„ ë˜ì§€ë§Œ, í•„ìš”í•˜ë©´ ìŠ¤í¬ë¡¤ ë¯¸ì„¸ ì¡°ì • ê°€ëŠ¥
    }

    // ë„ˆë¬´ ê¸¸ì–´ì§€ëŠ” ê²ƒ ë°©ì§€ (ì˜µì…˜: 400ê°œ ì´ˆê³¼ ì‹œ í•˜ë‹¨ë¶€í„° ì œê±°)
    const MAX_POSTS = 400;
    while (feedEl.children.length > MAX_POSTS) {
      feedEl.removeChild(feedEl.lastElementChild);
    }

  } catch (e) {
    console.warn('Auto refresh failed', e);
  }
}

function showNewPostBanner() {
  if (document.getElementById('new-post-banner')) return;
  const banner = document.createElement('div');
  banner.id = 'new-post-banner';
  banner.textContent = 'ìƒˆ ê¸€ì´ ì˜¬ë¼ì™”ìŠµë‹ˆë‹¤ â€” ìƒˆë¡œê³ ì¹¨';
  banner.style.cssText = `
    position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
    background: var(--card); color: var(--fg);
    border: 1px solid var(--border);
    border-radius: 999px; padding: 8px 16px;
    font-size: 13px; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    cursor: pointer; z-index: 1000; animation: fadeIn .25s ease;
  `;
  banner.addEventListener('click', async () => {
    banner.remove();
    // ì™„ì „ ìƒˆë¡œ ì±„ìš°ê¸°
    feedEl.innerHTML = '';
    cursor = null;
    await loadPage(true);
    await autofillIfNeeded();
  });
  document.body.appendChild(banner);
}

// íƒ­ì´ ë°±ê·¸ë¼ìš´ë“œë¡œ ê°€ë©´ í´ë§ ì ê¹ ë©ˆì¶”ê¸°(ë‚­ë¹„ ë°©ì§€)
document.addEventListener('visibilitychange', () => {
  if (document.hidden) stopPolling();
  else if (mode === 'home' && source === 'misskey') startPolling();
});


/* =========================
   Media rendering (Masto/Misskey)
   ========================= */
function renderMedia(post) {
  const media = Array.isArray(post?.media_attachments) ? post.media_attachments
               : Array.isArray(post?.files) ? post.files
               : [];
  if (!media.length) return '';
  const pieces = [];
  for (const m of media) {
    if (m?.type && (m.url || m.preview_url)) {
      if (m.type === 'image' || m.type === 'gifv') {
        pieces.push(`<img src="${m.preview_url || m.url}" loading="lazy" alt="" />`);
      } else if (m.type === 'video') {
        pieces.push(`<video src="${m.url}" controls playsinline></video>`);
      }
      continue;
    }
    if (m?.type && (m.url || m.thumbnailUrl)) {
      const isImage = String(m.type).startsWith('image/');
      if (isImage) pieces.push(`<img src="${m.thumbnailUrl || m.url}" loading="lazy" alt="" />`);
      else pieces.push(`<video src="${m.url}" controls playsinline></video>`);
      continue;
    }
    if (m?.url) pieces.push(`<img src="${m.url}" loading="lazy" alt="" />`);
  }
  return pieces.length ? `<div class="media">${pieces.join('')}</div>` : '';
}

/* =========================
   Post card rendering
   ========================= */
async function renderPostHTML(post, opts) {
  const { source } = opts; // 'masto' | 'misskey'

  if (source === 'masto') {
    const isReblog = !!post?.reblog;
    const base = isReblog ? post.reblog : post;   // ì›ê¸€
    const booster = isReblog ? post.account : null;

    const isMine = !!myMastoId && base?.account?.id === myMastoId;

    const acc = base?.account || {};
    const displayName = acc.display_name || acc.username || '';
    const handle = acc.acct ? `@${acc.acct}` : '';
    const createdAt = base?.created_at || '';
    const avatarURL = acc.avatar_static || acc.avatar || '';

    // ===== Mastodon ì»¤ìŠ¤í…€ ì´ëª¨ì§€ ë§µ (ì´ë¦„, ê³„ì •, íˆ¬í‘œ ë“±)
    const mastoEmojiMap = buildMastoEmojiMap(base);

    // ë³¸ë¬¸/ì´ë¦„ ë‚´ ì»¤ìŠ¤í…€ ì´ëª¨ì§€ ë Œë”
    const contentHTML = renderEmojisToHTML(base?.content || '', mastoEmojiMap);

    // ë¯¸ë””ì–´
    const mediaHTML = renderMedia(base);

    const faves = base?.favourites_count ?? 0;
    const boosts = base?.reblogs_count ?? 0;
    const replies = base?.replies_count ?? 0;

    // ===== Misskey ë¦¬ì•¡ì…˜ (ë¶€ìŠ¤íŠ¸/ì›ê¸€ ì–´ë””ì— ë‹¬ë¦¬ë“  ë‹¤ ì¡ê¸°)
    const mkReactions =
      (base && base._mkReactions) ||
      (post && post._mkReactions) ||
      null;

    // Misskey ì´ëª¨ì§€ URLì´ ë¹ ì§„ í•­ëª©ì´ ìˆìœ¼ë©´, ì´ëª¨ì§€ ë§µì„ ì›ê¸€/ê²‰ ê°ì²´ì˜ host ìš°ì„ ìˆœìœ„ë¡œ ì¡°íšŒ
    let mkEmojiList = [];
    const needMkEmoji = Array.isArray(mkReactions) && mkReactions.some(r => !r.url);
    if (needMkEmoji) {
      const deriveHost = () => {
        // 1) ëª…ì‹œ host
        if (base && base._mkHost) return base._mkHost;
        if (post && post._mkHost) return post._mkHost;
        // 2) ë””ë²„ê·¸ ì •ë³´ì— host
        if (base && base._mkDebug?.host) return base._mkDebug.host;
        if (post && post._mkDebug?.host) return post._mkDebug.host;
        // 3) apUriì—ì„œ ì¶”ì¶œ
        try {
          if (base && base._mkDebug?.apUri) return new URL(base._mkDebug.apUri).host;
        } catch {}
        try {
          if (post && post._mkDebug?.apUri) return new URL(post._mkDebug.apUri).host;
        } catch {}
        return null;
      };
      const mkReHost = deriveHost();
      mkEmojiList = mkReHost ? await getMisskeyEmojis(mkReHost) : [];
    }
    const resolveMkUrl = (name) => {
      const em = mkEmojiList.find(e => e?.name === name);
      return em?.url || null;
    };

    // ë¦¬ì•¡ì…˜ HTML
    let reactionsHTML = '';
    if (Array.isArray(mkReactions)) {
      const mkBadges = mkReactions.map(r => {
        const cnt = (typeof r.count === 'number' && r.count > 0) ? r.count : '';
        const url = r.url || (r.name && resolveMkUrl(r.name));
        if (!url && r.char) return `<span class="badge">${r.char} ${cnt}</span>`;
        if (url) return `<span class="badge"><img src="${url}" alt=":${r.name || ''}:" />${cnt}</span>`;
        return `<span class="badge">${r.name ?? ''} ${cnt}</span>`;
      }).join('');
      reactionsHTML += mkBadges;
    }

    // ğŸ”˜ ê¸°ë³¸ ì•¡ì…˜ë“¤ (ì›ê¸€ ID ê¸°ì¤€)
    const likeTargetId = base?.id || post?.id;
    reactionsHTML += `
      <button class="badge reply-toggle" data-id="${likeTargetId}" title="Show replies">ğŸ’¬ ${replies}</button>
      <span class="badge">â™º ${boosts}</span>
      <button class="badge ${isMine ? 'likers-toggle' : 'like-btn'}"
              data-id="${likeTargetId}"
              title="${isMine ? 'Show who liked' : 'Like'}">â­ ${faves}</button>
    `;

    // ë””ë²„ê·¸ ë¸”ëŸ­
    const debugOn = new URL(location.href).searchParams.get('debug') === '1'
      || new URL(location.href).searchParams.get('debug') === '2';
    const debugObj = (base && base._mkDebug) || (post && post._mkDebug);
    const debugHTML = (debugOn && debugObj)
      ? `<pre class="meta" style="white-space:pre-wrap;margin-top:8px;border:1px dashed var(--border);padding:8px;border-radius:8px;opacity:0.8;">_mkDebug: ${escapeHTML(JSON.stringify(debugObj, null, 2))}</pre>`
      : '';

    const likersBlock = `<div class="likers" data-for="${likeTargetId}" hidden></div>`;

    // âœ¨ ë¦¬ë¸”ë¡œê·¸ ì¹´ë“œ
    if (isReblog) {
      const boosterName = booster?.display_name || booster?.username || '';
      const boosterHandle = booster?.acct ? `@${booster.acct}` : '';
      const boosterAvatar = booster?.avatar_static || booster?.avatar || '';

      return `
        <article class="post reblog">
          <div class="reblog-banner">
            <span class="icon">â†»</span>
            <span class="user-chip">
              <img class="avatar-mini" src="${boosterAvatar}" alt="" loading="lazy">
              <strong>${escapeHTML(boosterName)}</strong> <span class="meta">${escapeHTML(boosterHandle)}</span>
            </span>
            <span class="meta">ë‹˜ì´ ë¶€ìŠ¤íŠ¸í–ˆìŠµë‹ˆë‹¤</span>
          </div>
          <div class="reblog-inner">
            <div class="post-head">
              <img class="avatar" src="${avatarURL}" alt="" loading="lazy">
              <div>
                <div class="name">${renderEmojisToHTML(escapeHTML(displayName), mastoEmojiMap)} <span class="meta">${escapeHTML(handle)}</span></div>
                <div class="meta">${new Date(createdAt).toLocaleString()}</div>
              </div>
            </div>
            <div class="content">${contentHTML}</div>
            ${mediaHTML}
            <div class="reactions">${reactionsHTML}</div>
            ${debugHTML}
          </div>
          <div class="thread" data-for="${likeTargetId}" hidden></div>
        </article>
      `;
    }

    // âœ¨ ì¼ë°˜ ì¹´ë“œ
    return `
      <article class="post">
        <div class="post-head">
          <img class="avatar" src="${avatarURL}" alt="" loading="lazy">
          <div>
            <div class="name">${renderEmojisToHTML(escapeHTML(displayName), mastoEmojiMap)} <span class="meta">${escapeHTML(handle)}</span></div>
            <div class="meta">${new Date(createdAt).toLocaleString()}</div>
          </div>
        </div>
        <div class="content">${contentHTML}</div>
        ${mediaHTML}
        <div class="reactions">${reactionsHTML}</div>
        ${likersBlock}
        ${debugHTML}
        <div class="thread" data-for="${likeTargetId}" hidden></div>
      </article>
    `;
  }

  // ===== Misskey íƒ€ì„ë¼ì¸ ë Œë” =====
  if (source === 'misskey') {
    const u = post?.user || {};
    const displayName = u.name || u.username || '';
    const handle = u.username ? `@${u.username}` : '';
    const createdAt = post?.createdAt || '';
    const avatarURL = u.avatarUrl || '';
    const host = getCookie('mk_host');

    const emojiList = await getMisskeyEmojis(host);
    const text = post?.text || '';
    const textHTML = renderEmojisToHTML(escapeHTML(text).replace(/\n/g, '<br>'), emojiList);
    const mediaHTML = renderMedia(post);

    const rx = post?.reactions || {};
    const rxBadges = [];
    if (rx && typeof rx === 'object') {
      for (const key of Object.keys(rx)) {
        const count = rx[key];
        const name = key.replace(/^:/, '').replace(/:$/, '');
        const em = emojiList.find(e => e.name === name);
        if (em?.url) rxBadges.push(`<span class="badge"><img src="${em.url}" alt=":${name}:" />${count}</span>`);
        else rxBadges.push(`<span class="badge">:${name}: ${count}</span>`);
      }
    }

    return `
      <article class="post">
        <div class="post-head">
          <img class="avatar" src="${avatarURL}" alt="" loading="lazy">
          <div>
            <div class="name">${renderEmojisToHTML(escapeHTML(displayName), emojiList)} <span class="meta">${escapeHTML(handle)}</span></div>
            <div class="meta">${new Date(createdAt).toLocaleString()}</div>
          </div>
        </div>
        <div class="content">${textHTML}</div>
        ${mediaHTML}
        <div class="reactions">${rxBadges.join('')}</div>
      </article>
    `;
  }

  return `<article class="post"><div class="content">Unsupported post</div></article>`;
}


/* =========================
   Timeline state & loaders
   ========================= */
const feedEl = document.getElementById('feed');
let myMastoId = null;   // Mastodon ë‚´ ê³„ì • ID
let myMkId = null;      // Misskey  ë‚´ ê³„ì • ID
let myAcct = null;      // Mastodon @acct (ë””ë²„ê·¸ìš©)
let mode = 'home'; // 'home' | 'fav'
let isLoading = false;
let cursor = null; // Masto: max_id, Misskey: untilId
let source = null; // 'masto' | 'misskey'
let activeHost = null;

function hasMastoCookies() {
  return !!getCookie('ap_token') && !!getCookie('ap_inst');
}
function hasMisskeyCookies() {
  return !!getCookie('mk_token') && !!getCookie('mk_host');
}

async function loadMe() {
  const preferMasto = hasMastoCookies();
  const preferMisskey = hasMisskeyCookies();

  const tryMasto = async () => {
    const me = await jfetch('/api/me');
    source = 'masto';
    activeHost = getCookie('ap_inst') || '';

    // í”„ë¡œí•„ í‘œì‹œìš© ë°ì´í„°
    const display = me?.display_name || me?.username || '';
    const handle  = me?.acct ? `@${me.acct}` : (me?.username ? `@${me.username}` : '');
    const avatar  = me?.avatar_static || me?.avatar || '';

    // ì´ëª¨ì§€ ë§µ(í”„ë¡œí•„ ì´ë¦„ì— ì»¤ìŠ¤í…€ ì´ëª¨ì§€ê°€ ìˆì„ ìˆ˜ ìˆìŒ)
    const list = Array.isArray(me?.emojis)
      ? me.emojis.map(e => {
          const name = e?.shortcode || e?.name;
          const url  = e?.url;
          return (name && url) ? { name, url } : null;
        }).filter(Boolean)
      : [];

    const nameEl = document.getElementById('acct-name');
    const avEl   = document.getElementById('acct-avatar');

    if (nameEl) {
      nameEl.innerHTML =
        `${renderEmojisToHTML(escapeHTML(display), list)} <span class="meta">${escapeHTML(handle)}</span>`;
    }
    if (avEl && avatar) {
      avEl.src = avatar;
    }

    myMastoId = me?.id || null;
    myAcct = me?.acct || null;
    return 'masto';
  };
  const tryMisskey = async () => {
    const me = await jfetch('/api/mk/me');
    source = 'misskey';
    activeHost = getCookie('mk_host') || '';

    const display = me?.name || me?.username || '';
    const handle  = me?.username ? `@${me.username}` : '';
    const avatar  = me?.avatarUrl || me?.avatar || '';

    const nameEl = document.getElementById('acct-name');
    const avEl   = document.getElementById('acct-avatar');

    if (nameEl) {
      nameEl.innerHTML =
        `${escapeHTML(display)} <span class="meta">${escapeHTML(handle)}</span>`;
    }
    if (avEl && avatar) {
      avEl.src = avatar;
    }

    myMkId = me?.id || null;
    return 'misskey';
  };


  try {
    if (preferMasto) return await tryMasto();
    if (preferMisskey) return await tryMisskey();
    return await tryMasto();
  } catch {
    try {
      if (source !== 'misskey') return await tryMisskey();
      return await tryMasto();
    } catch (e) {
      source = null;
      alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
      location.href = '/';
      throw e;
    }
  }
}

let io; // observer í•¸ë“¤

async function loadPage(initial=false) {
  if (isLoading || !source) return;
  isLoading = true;

  try {
    const path =
      mode === 'fav'
        ? (source === 'masto' ? '/api/favourites' : '/api/mk/home?favourites=1')
        : mode === 'mine'
          ? (source === 'masto' ? '/api/mine' : '/api/mk/mine')
          : (source === 'masto' ? '/api/home' : '/api/mk/home');


    const u = new URL(path, location.origin);
    u.searchParams.set('limit', '20');   // â¬…ï¸ ì²« í˜ì´ì§€ 20ê°œë§Œ
    if (cursor) {
      source === 'masto' ? u.searchParams.set('max_id', cursor)
                        : u.searchParams.set('untilId', cursor);
    }

    if (new URL(location.href).searchParams.get('debug') === '1') {
      u.searchParams.set('debug', '1');
    }

    const data = await jfetch(u.toString());
    // í™ˆì´ë©´ ìµœì‹ ê¸€ id ê¸°ì–µ(ì´ˆê¸° ì§„ì…/ë¦¬ë¡œë“œ ëª¨ë‘ ë°˜ì˜)
    if (mode === 'home') {
      const top = Array.isArray(data?.items) ? data.items[0] : Array.isArray(data) ? data[0] : null;
      lastTopId = top ? (top?.reblog?.id ?? top?.id ?? null) : lastTopId;
    }


    // â¬…ï¸ ì›ë³¸ ëª©ë¡ì„ ë”°ë¡œ ë³´ê´€ (ì»¤ì„œ ê³„ì‚°ì€ ì´ê±¸ë¡œ!)
    const rawItems = Array.isArray(data?.items) ? data.items : Array.isArray(data) ? data : [];
    let items = rawItems;

    // ì ì§„ ë Œë”: ìë¦¬ ë¨¼ì € ë§Œë“¤ê³ , ì¤€ë¹„ë˜ëŠ” ëŒ€ë¡œ êµì²´
    const frag = document.createDocumentFragment();
    const placeholders = items.map(() => {
      const ph = document.createElement('article');
      ph.className = 'post';
      ph.innerHTML = '<div class="meta">Loadingâ€¦</div>';
      frag.appendChild(ph);
      return ph;
    });
    feedEl.appendChild(frag);

    items.forEach(async (post, i) => {
      try {
        const html = await renderPostHTML(post, { source });
        const wrapper = document.createElement('div');
        wrapper.innerHTML = html;
        placeholders[i].replaceWith(wrapper.firstElementChild);
      } catch (e) {
        placeholders[i].innerHTML = '<div class="meta">Failed to render</div>';
      }
    });

    cursor = (source === 'masto')
      ? (data?.next_max_id || (rawItems.length ? rawItems[rawItems.length-1]?.id : null))
      : (data?.next || (rawItems.length ? rawItems[rawItems.length-1]?.id : null));
  } catch (e) {
    // @ts-ignore
    if (e?.status === 401) {
      if (source === 'misskey' && hasMastoCookies()) {
        console.warn('Misskey 401: Mastodonìœ¼ë¡œ ìë™ ì „í™˜í•©ë‹ˆë‹¤.');
        source = 'masto'; cursor = null; feedEl.innerHTML = '';
        await loadPage(true);
      } else {
        alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
        if (io?.disconnect) io.disconnect();
      }
    } else {
      console.error(e);
    }
  } finally {
    isLoading = false;
  }
}

// ì´ˆê¸° ë·°í¬íŠ¸ ìë™ ì±„ìš°ê¸°
async function autofillIfNeeded(maxLoops = 3) {
  for (let i = 0; i < maxLoops; i++) {
    const sentinel = document.getElementById('sentinel');
    if (!sentinel) break;
    const rect = sentinel.getBoundingClientRect();
    if (rect.top < window.innerHeight + 200) {
      await loadPage();
    } else {
      break;
    }
  }
}

/* =========================
   Realtime streaming (SSE)
   ========================= */
let es = null;                 // EventSource í•¸ë“¤
const seenIds = new Set();     // ì¤‘ë³µ ë°©ì§€ìš© (id ìºì‹œ, í•„ìš” ì‹œ í¬ê¸° ì œí•œ)

function postKey(item) {
  return item?.reblog?.id ?? item?.id ?? null;
}

// ìƒˆ ê¸€ì„ DOM ë§¨ ìœ„ì— ì‚½ì…
// ìƒˆ ê¸€ì„ "ìœ„ì—ì„œ ë‚´ë ¤ì˜¤ë“¯" ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ì‚½ì…
async function prependStatus(st) {
  const key = postKey(st);
  if (!key) return;
  if (seenIds.has(key)) return;
  seenIds.add(key);
  if (seenIds.size > 5000) { for (const k of seenIds) { seenIds.delete(k); if (seenIds.size <= 2500) break; } }

  // ë Œë” ê²°ê³¼ ë…¸ë“œ ë§Œë“¤ê¸°
  const html = await renderPostHTML(st, { source: 'masto' });
  const wrap = document.createElement('div');
  wrap.innerHTML = html;
  const node = wrap.firstElementChild;
  if (!node) return;

  // 1) ë¨¼ì € ì¸¡ì •ìš©ìœ¼ë¡œ DOMì— ì ê¹ ë¶™ì—¬ì„œ ë†’ì´ êµ¬í•¨(ë³´ì´ì§„ ì•Šê²Œ)
  node.style.position = 'absolute';
  node.style.visibility = 'hidden';
  node.style.pointerEvents = 'none';
  feedEl.insertBefore(node, feedEl.firstChild || null);
  const h = node.getBoundingClientRect().height || 0;
  // ì¸¡ì • í›„ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
  node.style.position = '';
  node.style.visibility = '';
  node.style.pointerEvents = '';

  // 2) ê¸°ì¡´ ëª©ë¡ì´ 'ë°€ë ¤ ë‚´ë ¤ê°€ëŠ”' ëŠë‚Œì„ ì£¼ê¸° ìœ„í•œ spacer
  const spacer = document.createElement('div');
  spacer.className = 'new-spacer';
  spacer.style.height = h + 'px'; // ì²˜ìŒì—” ìƒˆ ê¸€ ë†’ì´ë§Œí¼ ì°¨ì§€
  feedEl.insertBefore(spacer, node); // spacerê°€ ë” ìœ„, nodeê°€ ê·¸ ì•„ë˜(=ì‹¤ì œ ì²« ì¹´ë“œ ìë¦¬)

  // 3) ìƒˆ ê¸€ì— ìŠ¬ë¼ì´ë“œ ì¸ í´ë˜ìŠ¤ ì ìš©
  node.classList.add('slide-enter');
  // ë¦¬í”Œë¡œìš° ê°•ì œ í›„ í™œì„±í™”
  // eslint-disable-next-line no-unused-expressions
  node.getBoundingClientRect();
  node.classList.add('slide-enter-active');

  // 4) ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘: spacerëŠ” 0ìœ¼ë¡œ ì¤„ì´ê³ , ì¹´ë“œëŠ” ìœ„ì—ì„œ ë‚´ë ¤ì˜¤ë©° ë³´ì„
  requestAnimationFrame(() => {
    spacer.style.height = '0px';
  });

  // 5) ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ í›„ ì •ë¦¬
  const done = () => {
    node.classList.remove('slide-enter', 'slide-enter-active');
    spacer.remove();
    node.removeEventListener('transitionend', done);
  };
  node.addEventListener('transitionend', done, { once: true });

  // í˜¹ì‹œ ì²« ê¸€ì´ ì—†ìœ¼ë©´ ê·¸ëƒ¥ append
  if (!feedEl.firstElementChild) feedEl.appendChild(node);
}


function startStream() {
  if (es || source !== 'masto') return;
  es = new EventSource('/api/stream/user', { withCredentials: true });

  es.addEventListener('open', () => {
    // console.debug('SSE open');
  });
  es.addEventListener('error', (e) => {
    // console.warn('SSE error', e);
    // ì—ëŸ¬ê°€ ë‚˜ë©´ ë¸Œë¼ìš°ì €ê°€ ìë™ ì¬ì—°ê²° ì‹œë„í•¨
  });

  // Mastodon SSE ì´ë²¤íŠ¸: update/delete/notification/filters_changed ...
  es.addEventListener('update', async (evt) => {
    if (mode !== 'home') return; // í™ˆì—ì„œë§Œ ì‹¤ì‹œê°„ ë°˜ì˜
    try {
      const st = JSON.parse(evt.data);
      await prependStatus(st);

      // í™ˆ ìµœì‹  id ê°±ì‹  (ìë™ ìƒˆë¡œê³ ì¹¨ ë¡œì§ê³¼ë„ í˜¸í™˜)
      lastTopId = postKey(st) || lastTopId;
    } catch {}
  });

  // ì‚­ì œ ì´ë²¤íŠ¸ê°€ ì˜¤ë©´ DOMì—ì„œ ì§€ìš°ê¸°(ì„ íƒ)
  es.addEventListener('delete', (evt) => {
    const id = evt.data?.trim();
    if (!id) return;
    seenIds.delete(id);
    const article = feedEl.querySelector(`.post .like-btn[data-id="${CSS.escape(id)}"]`)?.closest('article');
    if (article) article.remove();
  });
}

function stopStream() {
  if (!es) return;
  try { es.close(); } catch {}
  es = null;
}


/* =========================
   UI bindings
   ========================= */
document.getElementById('tab-home').addEventListener('click', async () => {
  mode = 'home';
  cursor = null;
  feedEl.innerHTML = '';
  await loadPage(true);
  await autofillIfNeeded();
  if (source === 'masto') startStream();     // â¬…ï¸ í™ˆ ì§„ì… ì‹œ ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘
  else if (source === 'misskey') startPolling();
});

document.getElementById('tab-fav').addEventListener('click', async () => {
  mode = 'fav';
  stopPolling();      // â¬…ï¸ í™ˆ ì´íƒˆ ì‹œ ì •ì§€
  cursor = null; feedEl.innerHTML = '';
  await loadPage(true); await autofillIfNeeded();
});

// ì´ë¦„(ê³„ì • ì¹©) í´ë¦­ â†’ ë‚´ ê¸€
document.addEventListener('click', async (ev) => {
  const btn = ev.target.closest?.('#acct-btn');
  if (!btn) return;
  mode = 'mine';
  stopStream();      // â¬…ï¸ í™ˆ ì´íƒˆ ì‹œ ì •ì§€
  stopPolling();
  cursor = null;
  feedEl.innerHTML = '';
  await loadPage(true);
  await autofillIfNeeded();
});


document.getElementById('logout').addEventListener('click', async () => {
  try {
    if (source === 'masto') await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
    if (source === 'misskey') await fetch('/api/mk/logout', { method: 'POST', credentials: 'include' });
  } finally {
    location.href = '/';
  }
});

// ğŸ’¬ ëŒ“ê¸€ í† ê¸€ (Mastodon ì „ìš©)
const threadCache = new Map(); // id -> HTML string (ìºì‹œ)

document.addEventListener('click', async (ev) => {
  const btn = ev.target.closest('.reply-toggle');
  if (!btn) return;

  // ì†ŒìŠ¤ê°€ Misskeyë©´ ì•„ì§ ë¯¸êµ¬í˜„
  if (source !== 'masto') {
    alert('Misskey ëŒ€í™” ë³´ê¸°ëŠ” ì¤€ë¹„ ì¤‘ì´ì—ìš”!');
    return;
  }

  const id = btn.dataset.id;
  if (!id) return;

  // ì´ ê¸€ ì¹´ë“œ ì•„ë˜ì˜ thread ì»¨í…Œì´ë„ˆ ì°¾ê¸°
  // (ê°€ì¥ ê°€ê¹Œìš´ article ë‹¤ìŒ í˜•ì œë¡œ threadê°€ ìˆìŠµë‹ˆë‹¤)
  const article = btn.closest('article');
  let threadEl = article?.querySelector(`.thread[data-for="${CSS.escape(id)}"]`);
  if (!threadEl) {
    // í˜¹ì‹œ ëª» ì°¾ìœ¼ë©´ ì „ì²´ì—ì„œ íƒìƒ‰
    threadEl = document.querySelector(`.thread[data-for="${CSS.escape(id)}"]`);
  }
  if (!threadEl) return;

  // í† ê¸€: í¼ì³ì ¸ ìˆìœ¼ë©´ ì ‘ê¸°
  if (!threadEl.hasAttribute('hidden')) {
    threadEl.setAttribute('hidden', '');
    btn.title = 'Show replies';
    return;
  }

  // í¼ì¹˜ê¸°: ìºì‹œ ìˆìœ¼ë©´ ì¦‰ì‹œ ì‚¬ìš©
  if (threadCache.has(id)) {
    threadEl.innerHTML = threadCache.get(id);
    threadEl.removeAttribute('hidden');
    btn.title = 'Hide replies';
    return;
  }

  // ë¡œë”© í‘œì‹œ
  threadEl.innerHTML = `<div class="meta">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>`;
  threadEl.removeAttribute('hidden');

  try {
    // ë°±ì—”ë“œ í”„ë¡ì‹œë¡œ ì»¨í…ìŠ¤íŠ¸ ìš”ì²­
    const data = await jfetch(`/api/status/context?id=${encodeURIComponent(id)}`);
    const desc = Array.isArray(data?.descendants) ? data.descendants : [];
    if (!desc.length) {
      threadEl.innerHTML = `<div class="meta">ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      threadCache.set(id, threadEl.innerHTML);
      btn.title = 'Hide replies';
      return;
    }

    // í›„ì†ë“¤ì„ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬(ì›í•œë‹¤ë©´)
    desc.sort((a,b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());

    // ê° ëŒ“ê¸€ì„ ê¸°ì¡´ ë Œë”ëŸ¬ë¡œ ë Œë”
    const parts = [];
    for (const st of desc) {
      try {
        const html = await renderPostHTML(st, { source: 'masto' });
        parts.push(html);
      } catch {
        // ì‹¤íŒ¨í•œ ê±´ ê±´ë„ˆëœ€
      }
    }
    const htmlAll = parts.join('');
    threadEl.innerHTML = htmlAll || `<div class="meta">í‘œì‹œí•  ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    threadCache.set(id, threadEl.innerHTML);
    btn.title = 'Hide replies';
  } catch (e) {
    console.error('context fetch error', e);
    threadEl.innerHTML = `<div class="meta">ëŒ€í™”ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
  }
});

// ì¢‹ì•„ìš”(â­) ë²„íŠ¼ í´ë¦­
document.addEventListener('click', async (ev) => {
  const btn = ev.target.closest('.like-btn');
  if (!btn) return;

  const id = btn.dataset.id;
  if (!id) { console.error('like: missing data-id'); return; }

  const orig = btn.textContent || 'â­ 0';

  btn.disabled = true;
  btn.textContent = 'â­â€¦';
  try {
    const res = await fetch('/api/like', {
      method: 'POST',
      credentials: 'include',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ id })
    });

    // ì‘ë‹µ ë³¸ë¬¸(JSON ìš°ì„ )
    let payload = null;
    const ct = res.headers.get('content-type') || '';
    if (ct.includes('application/json')) {
      payload = await res.json().catch(() => null);
    } else {
      // ì‹¤íŒ¨ì‹œ ë””ë²„ê¹…ìš© í…ìŠ¤íŠ¸ë„ í™•ë³´
      payload = await res.text().catch(() => '');
    }

    if (!res.ok) {
      console.error('like failed', res.status, payload);
      btn.textContent = 'â­!';
      btn.title = res.status === 401 ? 'Mastodon ë¡œê·¸ì¸ í•„ìš”(ì„¸ì…˜ ë§Œë£Œ)' : `Like failed: ${res.status}`;
      return;
    }

    // âœ… ì„±ê³µ: í‘œì‹œ ìˆ«ì ê²°ì •
    // ì„œë²„ê°€ favourites_countë¥¼ ì£¼ë©´ ê·¸ ê°’ ì‚¬ìš©, ì—†ìœ¼ë©´ í˜„ì¬ì—ì„œ +1
    let newCount;
    if (payload && typeof payload.favourites_count === 'number') {
      newCount = payload.favourites_count;
    } else {
      const m = (orig.match(/^â­\s*(\d+)/));
      const cur = m ? parseInt(m[1], 10) : 0;
      newCount = cur + 1;
    }

    btn.textContent = `â­ ${newCount}`;
    btn.title = 'Liked!';
    btn.style.background = 'var(--btn-bg-hover)';

  } catch (e) {
    console.error('like error', e);
    btn.textContent = 'â­Ã—';
    btn.title = 'Network error';
  } finally {
    // â›” ì›ë˜ í…ìŠ¤íŠ¸ë¡œ ë˜ëŒë¦¬ì§€ ì•ŠìŒ
    btn.disabled = false;
  }
});


document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

// infinite scroll (disconnect ì§€ì›)
io = new IntersectionObserver(async (entries) => {
  for (const e of entries) {
    if (e.isIntersecting) await loadPage();
  }
}, { rootMargin: '600px' });
io.observe(document.getElementById('sentinel'));

// init
(async function init() {
  await loadMe();
  await loadPage(true);
  await autofillIfNeeded();

  // ì²« ì§„ì…ì´ í™ˆì´ë©´ í´ë§ ì‹œì‘
  if (mode === 'home') {
    if (source === 'masto') startStream();
    else if (source === 'misskey') startPolling();
  }
})();
</script>
</body>
</html>