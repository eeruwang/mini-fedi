<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fedi Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-dvh bg-neutral-50">
  <header class="sticky top-0 z-10 bg-white/70 backdrop-blur-md border-b shadow-sm">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center gap-3 justify-between">
      <div id="who" class="font-medium">Loadingâ€¦</div>
      <div class="flex gap-2">
        <button id="btnHome"   class="px-3 py-1.5 rounded-xl border bg-white">í™ˆ</button>
        <button id="btnFav"    class="px-3 py-1.5 rounded-xl border bg-white">ì¢‹ì•„ìš”</button>
        <button id="btnLogout" class="px-3 py-1.5 rounded-xl border bg-white">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-6">
    <div id="stats" class="flex gap-6 text-sm text-neutral-600"></div>
    <div id="feed" class="mt-4 space-y-3"></div>
    <div id="sentinel" class="h-10"></div>
  </main>

  <script>
    function esc(s){
      if (typeof s !== 'string') return ''
      return s.replace(/[&<>"']/g, c => (
        c === '&' ? '&amp;' :
        c === '<' ? '&lt;'  :
        c === '>' ? '&gt;'  :
        c === '"' ? '&quot;': '&#39;'
      ))
    }
    function reactionsRowMK(reactions){
      if (!reactions) return ''
      const items = Object.entries(reactions).map(([k,v]) =>
        `<span class="px-2 py-1 rounded-lg border bg-white">${esc(k)} ${v}</span>`)
      return items.length ? `<div class="flex flex-wrap gap-1 mt-2">${items.join('')}</div>` : ''
    }

    const who = document.getElementById('who')
    const stats = document.getElementById('stats')
    const feed = document.getElementById('feed')
    const btnHome = document.getElementById('btnHome')
    const btnFav = document.getElementById('btnFav')
    const btnLogout = document.getElementById('btnLogout')
    const sentinel = document.getElementById('sentinel')

    let kind = 'md'      // 'md' | 'mk'
    let loading = false
    let done = false     // ë” ë¶ˆëŸ¬ì˜¬ ê²Œ ì—†ëŠ”ì§€
    let paging = {       // í˜ì´ì§€ë„¤ì´ì…˜ ì»¤ì„œ
      md: { max_id: null, since_id: null },
      mk: { untilId: null, sinceId: null }
    }

    async function detectKind(){
      let r = await fetch('/api/me'); if (r.ok) return 'md'
      r = await fetch('/api/mk/me'); if (r.ok) return 'mk'
      location.href = '/'
    }

    // --- Mastodon ë Œë” ---
    function renderMeMD(m){
      who.textContent = `${m.display_name || m.username} (@${m.acct})`
      stats.innerHTML =
        `<div>íŒ”ë¡œì›Œ <b>${m.followers_count}</b></div>
         <div>íŒ”ë¡œì‰ <b>${m.following_count}</b></div>
         <div>í¬ìŠ¤íŠ¸ <b>${m.statuses_count}</b></div>`
    }
    function renderStatusesMD(list, { append=false } = {}){
      if (!append) feed.innerHTML = ''
      for (const s of list){
        const a = s.account
        const time = new Date(s.created_at).toLocaleString()
        const counts = `ğŸ” ${s.reblogs_count} Â· â­ ${s.favourites_count} Â· ğŸ’¬ ${s.replies_count}`
        const card = document.createElement('article')
        card.className = 'bg-white border rounded-2xl p-4'
        card.innerHTML =
          `<div class="text-sm text-neutral-600 mb-2">${esc(a.display_name||a.username)} (@${esc(a.acct)}) Â· <time>${time}</time> Â· ${counts}</div>
           <div class="prose max-w-none">${s.content||''}</div>
           ${s.mkReactions ? reactionsRowMK(s.mkReactions) : ''}`
        feed.appendChild(card)
      }
      if (!list.length && !append) feed.innerHTML = `<div class="bg-white border rounded-2xl p-4">í‘œì‹œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`
    }

    // --- Misskey ë Œë” ---
    function renderMeMK(me){
      who.textContent = `${me.name || me.username} (@${me.username})`
      stats.innerHTML =
        `<div>íŒ”ë¡œì›Œ <b>${me.followersCount}</b></div>
         <div>íŒ”ë¡œì‰ <b>${me.followingCount}</b></div>
         <div>ë…¸íŠ¸ <b>${me.notesCount}</b></div>`
    }
    function renderStatusesMK(list, { append=false } = {}){
      if (!append) feed.innerHTML = ''
      for (const n of list){
        const a = n.user || {}
        const time = new Date(n.createdAt).toLocaleString()
        const textHtml = (n.text || '').replace(/\n/g,'<br>')
        const card = document.createElement('article')
        card.className = 'bg-white border rounded-2xl p-4'
        card.innerHTML =
          `<div class="text-sm text-neutral-600 mb-2">${esc(a.name||a.username)} (@${esc(a.username)}) Â· <time>${time}</time></div>
           <div class="prose max-w-none">${textHtml}</div>
           ${reactionsRowMK(n.reactions)}`
        feed.appendChild(card)
      }
      if (!list.length && !append) feed.innerHTML = `<div class="bg-white border rounded-2xl p-4">í‘œì‹œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`
    }

    // --- ë°ì´í„° ë¡œë” ---
    async function loadMD({ reset=false } = {}){
      try {
        if (reset) {
          feed.innerHTML = ''
          done = false
          paging.md = { max_id: null, since_id: null }
          const meR = await fetch('/api/me'); if (!meR.ok) throw new Error('me failed')
          renderMeMD(await meR.json())
        }
        if (done || loading) return
        loading = true
        const params = new URLSearchParams({ limit: '20' })
        if (paging.md.max_id) params.set('max_id', paging.md.max_id)
        const homeR = await fetch(`/api/home?${params}`)
        if (!homeR.ok) throw new Error('home failed')
        const items = await homeR.json()
        renderStatusesMD(items, { append: true })
        // ë‹¤ìŒ ìš”ì²­ìš© max_id ê°±ì‹ : ë§ˆì§€ë§‰ ì•„ì´í…œì˜ id
        if (items.length) {
          paging.md.max_id = items[items.length - 1].id
        } else {
          done = true
        }
      } catch(e){
        feed.insertAdjacentHTML('beforeend', `<div class="bg-white border rounded-2xl p-4">ì˜¤ë¥˜: ${esc(String(e))}</div>`)
        done = true
      } finally {
        loading = false
      }
    }

    async function loadFavMD(){
      try {
        feed.innerHTML = ''
        done = true
        const fav = await (await fetch('/api/favourites')).json()
        renderStatusesMD(fav, { append:false })
      } catch(e){
        feed.innerHTML = `<div class="bg-white border rounded-2xl p-4">ì˜¤ë¥˜: ${esc(String(e))}</div>`
      }
    }

    async function loadMK({ reset=false } = {}){
      try {
        if (reset) {
          feed.innerHTML = ''
          done = false
          paging.mk = { untilId: null, sinceId: null }
          const meR = await fetch('/api/mk/me'); if (!meR.ok) throw new Error('me failed')
          renderMeMK(await meR.json())
        }
        if (done || loading) return
        loading = true
        const params = new URLSearchParams({ limit: '20' })
        if (paging.mk.untilId) params.set('untilId', paging.mk.untilId)
        const homeR = await fetch(`/api/mk/home?${params}`)
        if (!homeR.ok) throw new Error('home failed')
        const items = await homeR.json()
        renderStatusesMK(items, { append: true })
        if (items.length) {
          // MisskeyëŠ” ì˜¤ë˜ëœ ë°©í–¥ í˜ì´ì§€ë„¤ì´ì…˜ì— untilId ì‚¬ìš© â†’ ë§ˆì§€ë§‰ í•­ëª© id ì €ì¥
          paging.mk.untilId = items[items.length - 1].id
        } else {
          done = true
        }
      } catch(e){
        feed.insertAdjacentHTML('beforeend', `<div class="bg-white border rounded-2xl p-4">ì˜¤ë¥˜: ${esc(String(e))}</div>`)
        done = true
      } finally {
        loading = false
      }
    }

    // --- ë¬´í•œ ìŠ¤í¬ë¡¤ ---
    const io = new IntersectionObserver(async (entries)=>{
      for (const entry of entries) {
        if (entry.isIntersecting) {
          if (kind === 'md') await loadMD()
          else await loadMK()
        }
      }
    })

    ;(async ()=>{
      kind = await detectKind()
      document.getElementById('btnHome').onclick = async ()=>{
        if (kind==='md') await loadMD({ reset:true })
        else await loadMK({ reset:true })
      }
      document.getElementById('btnFav').onclick  = async ()=>{
        if (kind==='md') { await loadFavMD() } else { await loadMK({ reset:true }) }
      }
      document.getElementById('btnLogout').onclick = async ()=>{
        if (kind==='md') await fetch('/api/auth/logout',{method:'POST'})
        else await fetch('/api/mk/logout',{method:'POST'})
        location.href='/'
      }

      // ì²« ë¡œë“œ + ì˜µì €ë²„ ì‹œì‘
      if (kind==='md') await loadMD({ reset:true })
      else await loadMK({ reset:true })
      io.observe(sentinel)
    })()
  </script>
</body>
</html>